name: Sync Logo and Files

on:
  schedule:
    - cron: '0 0/1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-to-main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        ref: main
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config core.quotepath false  # é¿å…ä¸­æ–‡è·¯å¾„è½¬ä¹‰
        git config core.precomposeunicode true  # å¤„ç†unicodeæ–‡ä»¶å

    - name: Clone private repository (main branch for files)
      run: |
        git clone -b main --single-branch https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository_owner }}/tvepg.git private-repo-main

    - name: Sync specific files from main branch
      run: |
        # å®šä¹‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶æ•°ç»„
        files=(
          'snow_epg.xml'
          'snow_epg.xml.gz'
          'snow_epg.json'
          'README.md'
          'chuanliu.xml'
          'cqunicom.xml'
          'epgastro_mst.xml'
          # 'epgindonesia.xml'
          # 'epgsooka_mst.xml'
          # 'epgunifi.xml'
          'singtel.xml'
          'epghebei.xml'
        )
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶
        changed_files=()
        for file in "${files[@]}"; do
          if [ -f "private-repo-main/$file" ]; then
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–
            if ! cmp -s "private-repo-main/$file" "./$file" 2>/dev/null; then
              cp "private-repo-main/$file" "./$file"
              changed_files+=("$file")
              echo "âœ… Synced: $file"
            else
              echo "â„¹ï¸ No changes: $file"
            fi
          else
            echo "âš ï¸ File not found in main branch: $file"
          fi
        done
        
        # è®°å½•å˜åŒ–çš„æ–‡ä»¶
        if [ ${#changed_files[@]} -gt 0 ]; then
          echo "========================================="
          echo "ğŸ“ Changed files: ${changed_files[*]}"
          echo "file_changes=true" >> $GITHUB_ENV
        else
          echo "file_changes=false" >> $GITHUB_ENV
        fi

    - name: Clean up main temp repo
      run: |
        rm -rf private-repo-main
        echo "âœ… private-repo-main has been deleted"

    - name: Check for any changes in main
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœªè·Ÿè¸ªæˆ–ä¿®æ”¹çš„æ–‡ä»¶
        if git status --porcelain | grep -q .; then
          echo "âœ… Changes detected in main, will commit"
          echo "has_changes=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ No changes detected in main"
          echo "has_changes=false" >> $GITHUB_ENV
        fi

    - name: Commit and push changes to main
      if: env.has_changes == 'true'
      run: |
        # è®¾ç½®åŒ—äº¬æ—¶åŒºå¹¶è·å–æ—¶é—´
        export TZ='Asia/Shanghai'
        commit_time=$(date +'%Y-%m-%d %H:%M:%S %Z')
        
        git add .
        git commit -m "chore: sync files from private repository [åŒ—äº¬æ—¶é—´: $commit_time]"
        git push origin main

    - name: Log completion for main
      run: |
        if [ "$has_changes" = "true" ]; then
          echo "âœ… Files synced successfully to main branch"
        else
          echo "â„¹ï¸ All files in main branch are already up to date"
        fi

  sync-logo-to-logoInfo:
    runs-on: ubuntu-latest
    needs: sync-to-main  # ç¡®ä¿åœ¨ main åˆ†æ”¯åŒæ­¥å®Œæˆåæ‰§è¡Œ
    steps:
    - name: Checkout logo_info branch
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        ref: logo_info
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config core.quotepath false  # é¿å…ä¸­æ–‡è·¯å¾„è½¬ä¹‰
        git config core.precomposeunicode true  # å¤„ç†unicodeæ–‡ä»¶å

    - name: Clone private repository (main branch for logo)
      run: |
        git clone -b main --single-branch https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository_owner }}/tvepg.git private-repo-main-logo

    - name: Clone private repository (logo_info branch for other files)
      run: |
        git clone -b logo_info --single-branch https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository_owner }}/tvepg.git private-repo-logo-info

    - name: Create logo directory if not exists
      run: |
        if [ ! -d "logo" ]; then
          mkdir -p logo
          echo "âœ… Created logo directory"
        fi

    - name: Sync logo files from main branch
      run: |
        if [ -d "private-repo-main-logo/logo" ]; then
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ¯”å¯¹
          mkdir -p temp_logo_sync
          cp -r private-repo-main-logo/logo/* temp_logo_sync/ 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          has_changes=false
          
          # æ£€æŸ¥æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          for file in temp_logo_sync/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [ -f "logo/$filename" ]; then
                if ! cmp -s "temp_logo_sync/$filename" "logo/$filename"; then
                  cp "temp_logo_sync/$filename" "logo/$filename"
                  echo "âœ… Updated: $filename"
                  has_changes=true
                fi
              else
                cp "temp_logo_sync/$filename" "logo/$filename"
                echo "ğŸ†• Added: $filename"
                has_changes=true
              fi
            fi
          done
          
          # æ£€æŸ¥éœ€è¦åˆ é™¤çš„æ–‡ä»¶
          for file in logo/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [ ! -f "temp_logo_sync/$filename" ]; then
                rm "$file"
                echo "âœ… Deleted: $filename"
                has_changes=true
              fi
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf temp_logo_sync
          
          if [ "$has_changes" = true ]; then
            echo "========================================="
            echo "âœ… Logo files synced with changes"
            echo "logo_changes=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No logo changes detected"
            echo "logo_changes=false" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ Logo folder not found in main branch"
          echo "logo_changes=false" >> $GITHUB_ENV
        fi

    - name: Sync and modify files from logo_info branch
      run: |
        # å®šä¹‰éœ€è¦æ›¿æ¢é“¾æ¥å†åŒæ­¥çš„æ–‡ä»¶æ•°ç»„
        files=(
          'README.md'
          'logo.json'
        )
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶å¹¶è¿›è¡Œé“¾æ¥æ›¿æ¢
        file_changes=false
        for file in "${files[@]}"; do
          if [ -f "private-repo-logo-info/$file" ]; then
            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºå¤„ç†
            temp_file="temp_$file"
            cp "private-repo-logo-info/$file" "$temp_file"
            
            # æ›¿æ¢æ–‡ä»¶ä¸­çš„é“¾æ¥
            sed -i 's|tvepg/main|myepg/logo_info|g' "$temp_file"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–
            if [ -f "./$file" ]; then
              if ! cmp -s "$temp_file" "./$file"; then
                cp "$temp_file" "./$file"
                echo "âœ… Synced and modified: $file"
                file_changes=true
              else
                echo "â„¹ï¸ No changes: $file"
              fi
            else
              cp "$temp_file" "./$file"
              echo "ğŸ†• Added and modified: $file"
              file_changes=true
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$temp_file"
          else
            echo "âš ï¸ File not found in logo_info branch: $file"
          fi
        done
        
        # è®°å½•æ–‡ä»¶å˜åŒ–
        if [ "$file_changes" = true ]; then
          echo "file_content_changes=true" >> $GITHUB_ENV
        else
          echo "file_content_changes=false" >> $GITHUB_ENV
        fi

    - name: Sync other files from logo_info branch
      run: |
        # å®šä¹‰éœ€è¦åŒæ­¥ä½†æ— éœ€å¤„ç†çš„å…¶ä»–æ–‡ä»¶æ•°ç»„ï¼ˆæ’é™¤å·²ç»å¤„ç†çš„æ–‡ä»¶ï¼‰
        other_files=(
          'logo_112114.json'
          'logo_112114.md'
          'logo_fanmingming.json'
          'logo_fanmingming.md'
          'logo_taksssss.json'
          'logo_taksssss.md'
        )
        
        # å¦‚æœæ²¡æœ‰å®šä¹‰å…¶ä»–æ–‡ä»¶ï¼Œåˆ™è·³è¿‡
        if [ ${#other_files[@]} -eq 0 ]; then
          echo "â„¹ï¸ No other files defined for sync"
          echo "other_files_changes=false" >> $GITHUB_ENV
          exit 0
        fi
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶
        other_changes=false
        for file in "${other_files[@]}"; do
          if [ -f "private-repo-logo-info/$file" ]; then
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–
            if [ -f "./$file" ]; then
              if ! cmp -s "private-repo-logo-info/$file" "./$file"; then
                cp "private-repo-logo-info/$file" "./$file"
                echo "âœ… Synced: $file"
                other_changes=true
              else
                echo "â„¹ï¸ No changes: $file"
              fi
            else
              cp "private-repo-logo-info/$file" "./$file"
              echo "ğŸ†• Added: $file"
              other_changes=true
            fi
          else
            echo "âš ï¸ File not found in logo_info branch: $file"
          fi
        done
        
        # è®°å½•å˜åŒ–
        if [ "$other_changes" = true ]; then
          echo "other_files_changes=true" >> $GITHUB_ENV
        else
          echo "other_files_changes=false" >> $GITHUB_ENV
        fi

    - name: Clean up temp repos
      run: |
        rm -rf private-repo-main-logo
        rm -rf private-repo-logo-info
        echo "âœ… Temporary repositories have been deleted"

    - name: Check for any changes in logo_info
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜åŒ–ï¼ˆlogoå˜åŒ–ã€æ–‡ä»¶å†…å®¹å˜åŒ–æˆ–å…¶ä»–æ–‡ä»¶å˜åŒ–ï¼‰
        if [ "$logo_changes" = "true" ] || [ "$file_content_changes" = "true" ] || [ "$other_files_changes" = "true" ]; then
          echo "âœ… Changes detected in logo_info, will commit"
          echo "has_changes=true" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ No changes detected in logo_info"
          echo "has_changes=false" >> $GITHUB_ENV
        fi

    - name: Commit and push changes to logo_info
      if: env.has_changes == 'true'
      run: |
        # è®¾ç½®åŒ—äº¬æ—¶åŒºå¹¶è·å–æ—¶é—´
        export TZ='Asia/Shanghai'
        commit_time=$(date +'%Y-%m-%d %H:%M:%S %Z')
        
        # æ„å»ºæäº¤ä¿¡æ¯
        commit_message="chore: sync files to logo_info [åŒ—äº¬æ—¶é—´: $commit_time]"
        
        # æ·»åŠ è¯¦ç»†çš„å˜æ›´ä¿¡æ¯
        if [ "$logo_changes" = "true" ]; then
          commit_message="$commit_message\n- Logo files updated from main branch"
        fi
        
        if [ "$file_content_changes" = "true" ]; then
          commit_message="$commit_message\n- README.md and logo.json links updated"
        fi
        
        if [ "$other_files_changes" = "true" ]; then
          commit_message="$commit_message\n- Other files synced from logo_info branch"
        fi
        
        git add .
        git commit -m "$commit_message"
        git push origin logo_info

    - name: Log completion for logo_info
      run: |
        if [ "$has_changes" = "true" ]; then
          echo "âœ… Logo and files synced successfully to logo_info branch"
        else
          echo "â„¹ï¸ Logo and files in logo_info branch are already up to date"
        fi