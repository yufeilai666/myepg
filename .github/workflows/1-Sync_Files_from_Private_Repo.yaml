name: 1 Sync Files from Private Repo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0/1 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      
    - name: Sync files from private repository
      id: sync_files
      run: |
        # éœ€è¦åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨ - ä½¿ç”¨æ•°ç»„å½¢å¼ï¼Œæ”¯æŒæ³¨é‡Š
        files=(
          'snow_epg.xml'
          'snow_epg.xml.gz'
          'snow_epg.json'
          'README.md'
          'chuanliu.xml'
          'cqunicom.xml'
          'epgastro_mst.xml'
          # 'epgindonesia.xml'
          # 'epgsooka_mst.xml'
          # 'epgunifi.xml',
          'singtel.xml'
          'epghebei.xml'
        )
        
        changed_files=()
        failed_files=()
        success_files=()
        new_files=()
        
        echo "Starting sync process..."
        echo "Files to process: ${#files[@]}"
        
        # å…ˆæ£€æŸ¥å½“å‰ç›®å½•çš„æ–‡ä»¶çŠ¶æ€
        # echo "Current directory files:"
        # ls -la || echo "No files in directory"
        
        for file in "${files[@]}"; do
          # è·³è¿‡æ³¨é‡Šè¡Œï¼ˆä»¥#å¼€å¤´çš„å…ƒç´ ï¼‰
          if [[ $file =~ ^# ]]; then
            echo "â„¹ï¸ Skipping commented file: $file"
            continue
          fi
          
          echo "========================================="
          echo "â„¹ï¸ Processing: $file"
          
          # æ£€æŸ¥æ–‡ä»¶å½“å‰çŠ¶æ€
          if [ -f "$file" ]; then
            echo "ğŸ“ File exists locally: $file"
            local_exists=true
          else
            echo "ğŸ“ File does NOT exist locally: $file"
            local_exists=false
          fi
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥ä¸‹è½½å†…å®¹
          temp_file=$(mktemp)
          http_code=$(curl -s -o "$temp_file" -w "%{http_code}" -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/${{ github.repository_owner }}/tvepg/contents/$file")
          
          if [ "$http_code" -eq 200 ]; then
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ -s "$temp_file" ]; then
              file_size=$(wc -c < "$temp_file")
              
              if [ "$local_exists" = true ]; then
                # æ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ–
                if cmp -s "$temp_file" "$file"; then
                  echo "â„¹ï¸ File unchanged: $file (size: $file_size bytes)"
                  rm -f "$temp_file"
                  success_files+=("$file")
                else
                  echo "âœ… File changed: $file (size: $file_size bytes)"
                  mv "$temp_file" "$file"
                  changed_files+=("$file")
                  success_files+=("$file")
                fi
              else
                # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥æ·»åŠ ä¸ºæ–°æ–‡ä»¶
                echo "ğŸ†• File added (new): $file (size: $file_size bytes)"
                mv "$temp_file" "$file"
                changed_files+=("$file")
                new_files+=("$file")
                success_files+=("$file")
              fi
            else
              echo "âŒ Downloaded file is empty: $file"
              rm -f "$temp_file"
              failed_files+=("$file")
            fi
          else
            echo "âŒ Failed to download: $file (HTTP code: $http_code)"
            rm -f "$temp_file"
            failed_files+=("$file")
          fi
        done
        
        # è¾“å‡ºç»“æœ
        echo "========================================="
        echo "â„¹ï¸ SYNC RESULT:"
        echo "  â”– âœ… Successfully processed: ${#success_files[@]} files"
        echo "  â”– ğŸ“ Actually changed: ${#changed_files[@]} files" 
        echo "    â”– ğŸ“„ New: ${#new_files[@]} files"
        echo "  â”– âŒ Failed to download: ${#failed_files[@]} files"
        
        if [ ${#changed_files[@]} -gt 0 ]; then
          echo "  â”– ğŸ‰ Changed files: ${changed_files[*]}"
        fi
        
        if [ ${#new_files[@]} -gt 0 ]; then
          echo "    â”– ğŸ†• New files: ${new_files[*]}"
        fi
        
        if [ ${#failed_files[@]} -gt 0 ]; then
          echo "    â”– âš ï¸ Failed files: ${failed_files[*]}"
        fi
        
        # è®¾ç½®è¾“å‡º
        if [ ${#changed_files[@]} -gt 0 ]; then
          echo "changed_files=true" >> $GITHUB_OUTPUT
          echo "changed_files_count=${#changed_files[@]}" >> $GITHUB_OUTPUT
          echo "changed_files_list=${changed_files[*]}" >> $GITHUB_OUTPUT
          echo "new_files_count=${#new_files[@]}" >> $GITHUB_OUTPUT
          echo "new_files_list=${new_files[*]}" >> $GITHUB_OUTPUT
        else
          echo "changed_files=false" >> $GITHUB_OUTPUT
          echo "changed_files_count=0" >> $GITHUB_OUTPUT
          echo "new_files_count=0" >> $GITHUB_OUTPUT
        fi
        
        echo "success_files_count=${#success_files[@]}" >> $GITHUB_OUTPUT
        echo "failed_files_count=${#failed_files[@]}" >> $GITHUB_OUTPUT
        
    - name: Commit and push changes
      if: steps.sync_files.outputs.changed_files_count > 0
      env:
        CHANGED_FILES_LIST: ${{ steps.sync_files.outputs.changed_files_list }}
        NEW_FILES_LIST: ${{ steps.sync_files.outputs.new_files_list }}
        NEW_FILES_COUNT: ${{ steps.sync_files.outputs.new_files_count }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        echo "ğŸ‰ Changed files: $CHANGED_FILES_LIST"
        if [ "$NEW_FILES_COUNT" -gt 0 ]; then
          echo "  â”– ğŸ†• New files: $NEW_FILES_LIST"
        fi
        echo "========================================="
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
        IFS=' ' read -ra FILES <<< "$CHANGED_FILES_LIST"
        for file in "${FILES[@]}"; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            file_size=$(wc -c < "$file")
            echo "â„¹ï¸ Adding $file to git (size: $file_size bytes)"
            git add "$file"
          fi
        done
        
        echo "========================================="
        
        # æ„å»ºæäº¤ä¿¡æ¯
        commit_msg="sync: update files from tvepg at $BEIJING_TIME"
        if [ "$NEW_FILES_COUNT" -gt 0 ]; then
          commit_msg="$commit_msg"$'\n'"  - Added new files: $NEW_FILES_LIST"
        fi
        commit_msg="$commit_msg"$'\n'"  - Updated: $CHANGED_FILES_LIST"$'\n'"  - Auto-sync from private repository"
        
        git commit -m "$commit_msg"
        
        echo "Pushing changes to repository..."
        git push
        
        echo "========================================="
        echo "âœ… Successfully synced and committed changes"
        
    - name: No changes detected
      if: steps.sync_files.outputs.changed_files_count == 0
      run: |
        echo "â„¹ï¸ SYNC COMPLETED: No new changes detected"
        
        if [ "${{ steps.sync_files.outputs.success_files_count }}" -eq 0 ] && [ "${{ steps.sync_files.outputs.failed_files_count }}" -gt 0 ]; then
          echo "âŒ All file downloads failed"
          exit 1
        else
          echo "âœ… All files are already in sync"
        fi