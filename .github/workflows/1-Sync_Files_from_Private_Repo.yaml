name: 1 Sync Files from Private Repo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0/1 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      
    - name: Sync files from private repository
      id: sync_files
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const https = require('https');
          const http = require('http');
          
          // å®šä¹‰éœ€è¦åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨
          const files = [
            'snow_epg.xml',
            'snow_epg.xml.gz',
            # 'snow_epg.json',
            'README.md', 
            'chuanliu.xml',
            'cqunicom.xml',
            'epgastro_mst.xml',
            # 'epgindonesia.xml',
            # 'epgsooka_mst.xml',
            # 'epgunifi.xml',
            'singtel.xml',
            'epghebei.xml'
          ];
          
          let successFiles = [];
          let changedFiles = [];
          
          console.log('Starting file sync from private repository...');
          console.log('Files to sync:', files);
          
          // ä¸‹è½½æ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
          const downloadFile = (url, filePath, token) => {
            return new Promise((resolve, reject) => {
              const protocol = url.startsWith('https') ? https : http;
              const headers = {
                'User-Agent': 'GitHub-Actions-Workflow',
                'Authorization': `token ${token}`
              };
              
              protocol.get(url, { headers }, (response) => {
                if (response.statusCode !== 200) {
                  reject(new Error(`Failed to download: ${response.statusCode}`));
                  return;
                }
                
                const fileStream = fs.createWriteStream(filePath);
                response.pipe(fileStream);
                
                fileStream.on('finish', () => {
                  fileStream.close();
                  resolve();
                });
                
                fileStream.on('error', (err) => {
                  fs.unlink(filePath, () => {}); // åˆ é™¤ä¸å®Œæ•´çš„æ–‡ä»¶
                  reject(err);
                });
              }).on('error', (err) => {
                reject(err);
              });
            });
          };
          
          for (const file of files) {
            try {
              console.log(`\nProcessing: ${file}`);
              
              // è·å–æ–‡ä»¶ä¿¡æ¯
              const response = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: 'tvepg',
                path: file,
                headers: {
                  authorization: `token ${{ secrets.PAT_TOKEN }}`
                }
              });
              
              const fileInfo = response.data;
              
              // æ£€æŸ¥æ–‡ä»¶å¤§å° - å¦‚æœè¶…è¿‡1MBï¼Œä½¿ç”¨ä¸‹è½½URL
              let sourceContent;
              if (fileInfo.size > 1000000) { // 1MB
                console.log(`File is large (${fileInfo.size} bytes), using download URL`);
                const tempPath = `temp_${file}`;
                await downloadFile(fileInfo.download_url, tempPath, '${{ secrets.PAT_TOKEN }}');
                sourceContent = fs.readFileSync(tempPath, 'utf8');
                fs.unlinkSync(tempPath); // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              } else {
                // å°æ–‡ä»¶ç›´æ¥ä½¿ç”¨base64è§£ç 
                sourceContent = Buffer.from(fileInfo.content, 'base64').toString();
              }
              
              // æ£€æŸ¥æœ¬åœ°æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å†…å®¹æ˜¯å¦ç›¸åŒ
              let needsUpdate = true;
              if (fs.existsSync(file)) {
                const localContent = fs.readFileSync(file, 'utf8');
                if (localContent === sourceContent) {
                  needsUpdate = false;
                  console.log(`âœ“ No changes for: ${file}`);
                }
              }
              
              // åªæœ‰å†…å®¹ä¸åŒæ—¶æ‰å†™å…¥æ–‡ä»¶
              if (needsUpdate) {
                fs.writeFileSync(file, sourceContent);
                changedFiles.push(file);
                console.log(`âœ… Updated: ${file}`);
                console.log(`File size: ${sourceContent.length} characters`);
              }
              
              successFiles.push(file);
              
            } catch (error) {
              console.log(`âŒ Failed to sync ${file}: ${error.message}`);
              // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œä¸ä¸­æ–­æµç¨‹
            }
          }
          
          // è¾“å‡ºç»“æœæ‘˜è¦
          console.log('\n=== Sync Summary ===');
          console.log(`âœ… Successfully processed: ${successFiles.length}/${files.length} files`);
          console.log(`ğŸ“ Files updated: ${changedFiles.length} files`);
          if (changedFiles.length > 0) {
            console.log(`Changed files: ${changedFiles.join(', ')}`);
          } else {
            console.log('No files were updated - all files are already in sync');
          }
          
          // è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          core.setOutput('changed_files', changedFiles.length > 0 ? 'true' : 'false');
          core.setOutput('changed_files_list', changedFiles.join(','));
          core.setOutput('success_files', successFiles.join(','));
          
    - name: Commit and push changes
      if: steps.sync_files.outputs.changed_files == 'true'
      env:
        CHANGED_FILES_LIST: ${{ steps.sync_files.outputs.changed_files_list }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        echo "Changed files: $CHANGED_FILES_LIST"
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œç¡®ä¿ä¸æ˜¯ç©ºæ–‡ä»¶
        IFS=',' read -ra FILES <<< "$CHANGED_FILES_LIST"
        for file in "${FILES[@]}"; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            echo "Adding $file to git (size: $(wc -c < "$file") bytes)"
            git add "$file"
          else
            echo "Warning: $file does not exist or is empty, skipping"
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å®é™…è¢«æ·»åŠ 
        if git diff --staged --quiet; then
          echo "No changes to commit after filtering empty files"
          exit 0
        fi
        
        # æäº¤ä¿¡æ¯åŒ…å«åŒ—äº¬æ—¶é—´
        git commit -m "sync: update files from tvepg at $BEIJING_TIME
        
        - Updated: $CHANGED_FILES_LIST
        - Auto-sync from private repository"
        
        echo "Pushing changes to repository..."
        git push
        
        echo "âœ… Successfully synced and committed changes"
        
    - name: No changes detected
      if: steps.sync_files.outputs.changed_files == 'false'
      run: |
        echo "âœ… All files are already up to date, no changes to commit"