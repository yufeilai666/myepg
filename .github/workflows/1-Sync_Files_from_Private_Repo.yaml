name: 1 Sync Files from Private Repo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0/1 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      
    - name: Sync files from private repository
      id: sync_files
      run: |
        # éœ€è¦åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨ - ä½¿ç”¨æ•°ç»„å½¢å¼ï¼Œæ”¯æŒæ³¨é‡Š
        files=(
          'snow_epg.xml'
          'snow_epg.xml.gz'
          # 'snow_epg.json'
          'README.md'
          'chuanliu.xml'
          'cqunicom.xml'
          'epgastro_mst.xml'
          # 'epgindonesia.xml'
          # 'epgsooka_mst.xml'
          # 'epgunifi.xml',
          'singtel.xml'
          'epghebei.xml'
        )
        
        changed_files=()
        failed_files=()
        success_files=()
        
        echo "Starting sync process..."
        echo "Files to process: ${#files[@]}"
        
        for file in "${files[@]}"; do
          # è·³è¿‡æ³¨é‡Šè¡Œï¼ˆä»¥#å¼€å¤´çš„å…ƒç´ ï¼‰
          if [[ $file =~ ^# ]]; then
            echo "â„¹ï¸ Skipping commented file: $file"
            continue
          fi
          
          echo "========================================="
          echo "â„¹ï¸ Processing: $file"
          
          # ç›´æ¥ä¸‹è½½æ–‡ä»¶åˆ°ç£ç›˜ï¼Œä¸é€šè¿‡å˜é‡ä¸­è½¬
          http_code=$(curl -s -o "$file" -w "%{http_code}" -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/${{ github.repository_owner }}/tvepg/contents/$file")
          
          if [ "$http_code" -eq 200 ]; then
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ -s "$file" ]; then
              file_size=$(wc -c < "$file")
              echo "âœ… Successfully downloaded: $file (size: $file_size bytes)"
              changed_files+=("$file")
              success_files+=("$file")
            else
              echo "âŒ Downloaded file is empty: $file"
              rm -f "$file"
              failed_files+=("$file")
            fi
          else
            echo "âŒ Failed to download: $file (HTTP code: $http_code)"
            # æ¸…ç†å¯èƒ½åˆ›å»ºçš„ç©ºæ–‡ä»¶
            rm -f "$file"
            failed_files+=("$file")
          fi
        done
        
        # è¾“å‡ºç»“æœ
        echo "========================================="
        echo "â„¹ï¸ SYNC RESULT:"
        echo "  â”– âœ… Successfully downloaded: ${#success_files[@]} files"
        echo "  â”– âŒ Failed to download: ${#failed_files[@]} files"
        
        if [ ${#success_files[@]} -gt 0 ]; then
          echo "  â”– ğŸ‰ Success files: ${success_files[*]}"
        fi
        
        if [ ${#failed_files[@]} -gt 0 ]; then
          echo "  â”– âš ï¸ Failed files: ${failed_files[*]}"
        fi
        
        # è®¾ç½®è¾“å‡º
        if [ ${#changed_files[@]} -gt 0 ]; then
          echo "changed_files=true" >> $GITHUB_OUTPUT
          echo "changed_files_count=${#changed_files[@]}" >> $GITHUB_OUTPUT
          echo "changed_files_list=${changed_files[*]}" >> $GITHUB_OUTPUT
        else
          echo "changed_files=false" >> $GITHUB_OUTPUT
          echo "changed_files_count=0" >> $GITHUB_OUTPUT
        fi
        
        echo "success_files_count=${#success_files[@]}" >> $GITHUB_OUTPUT
        echo "failed_files_count=${#failed_files[@]}" >> $GITHUB_OUTPUT
        
    - name: Commit and push changes
      if: steps.sync_files.outputs.changed_files_count > 0
      env:
        CHANGED_FILES_LIST: ${{ steps.sync_files.outputs.changed_files_list }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        echo "â„¹ï¸ Changed files: $CHANGED_FILES_LIST"
        echo "========================================="
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
        IFS=' ' read -ra FILES <<< "$CHANGED_FILES_LIST"
        for file in "${FILES[@]}"; do
          if [ -f "$file" ] && [ -s "$file" ]; then
            file_size=$(wc -c < "$file")
            echo "â„¹ï¸ Adding $file to git (size: $file_size bytes)"
            git add "$file"
          fi
        done
        
        echo "========================================="
        # ä½¿ç”¨å¤šä¸ª -m å‚æ•°æ¥åˆ›å»ºå¤šè¡Œæäº¤ä¿¡æ¯
        git commit -m "sync: update files from tvepg at $BEIJING_TIME" \
          -m "  - Updated: $CHANGED_FILES_LIST" \
          -m "  - Auto-sync from private repository"
        
        echo "Pushing changes to repository..."
        git push
        
        echo "========================================="
        echo "âœ… Successfully synced and committed changes"
        
    - name: No changes detected
      if: steps.sync_files.outputs.changed_files_count == 0
      run: |
        echo "========================================="
        echo "â„¹ï¸ SYNC COMPLETED: No new changes detected"
        
        if [ "${{ steps.sync_files.outputs.success_files_count }}" -eq 0 ] && [ "${{ steps.sync_files.outputs.failed_files_count }}" -gt 0 ]; then
          echo "âŒ All file downloads failed"
          exit 1
        else
          echo "âœ… All files are already in sync"
        fi